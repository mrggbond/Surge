// block_ps_traffic.js
// Script modified to return true for block, false/null otherwise
// To be used with a rule like: SCRIPT,BlockPS4Traffic,REJECT

const TARGET_SOURCE_IP = "192.168.32.2";

const BLOCKED_DEST_IPS = new Set([
    "23.46.198.204",
    // ... (all your other destination IPs)
    "2.16.149.5", "2.16.149.29", "2.16.149.31", "2.16.168.103", "2.16.168.112",
    "2.16.168.116", "2.16.170.217", "2.16.170.218", "2.17.1.238", "2.17.57.196",
    "2.17.175.235", "2.18.148.58", "2.19.80.147", "2.19.80.153", "2.20.166.124",
    "2.23.81.34", "2.23.81.91", "23.1.161.73", "23.1.169.12", "23.2.80.155",
    "23.7.34.92", "23.9.71.133", "23.10.76.28", "23.32.45.9", "23.32.45.10",
    "23.32.142.205", "23.33.18.202", "23.33.36.65", "23.33.90.72", "23.33.90.80",
    "23.34.35.12", "23.34.38.105", "23.34.81.8", "23.34.81.9", "23.34.172.49",
    "23.34.172.59", "23.35.112.109", "23.35.185.187", "23.35.186.204", "23.36.142.189",
    "23.38.194.41", "23.38.194.68", "23.38.227.189", "23.39.54.39", "23.39.217.165",
    "23.40.99.140", "23.40.99.147", "23.40.169.212", "23.40.194.113", "23.41.4.198",
    "23.41.4.206", "23.41.4.209", "23.41.4.212", "23.41.4.219", "23.41.27.237",
    "23.41.37.190", "23.42.176.57", "23.42.177.192", "23.42.181.192", "23.43.1.124",
    "23.43.50.16", "23.43.82.9", "23.43.82.33", "23.44.217.104", "23.45.141.187",
    "23.45.147.236", "23.45.207.199", "23.45.207.202", "23.46.63.136", "23.46.63.146",
    "23.46.197.187", /* "23.46.198.204", removed duplicate */ "23.46.228.38", "23.46.228.49", "23.49.101.104",
    "23.49.104.174", "23.49.104.180", "23.51.2.49", "23.51.61.98", "23.52.77.253",
    "23.53.122.197", "23.53.122.198", "23.54.34.199", "23.54.155.77", "23.54.155.78",
    "23.54.155.103", "23.54.155.112", "23.54.155.169", "23.54.155.173", "23.54.254.85",
    "23.55.39.136", "23.55.39.177", "23.55.44.45", "23.55.44.51", "23.55.44.78",
    "23.55.44.81", "23.55.168.169", "23.55.168.194", "23.55.168.210", "23.55.209.191",
    "23.55.236.138", "23.55.236.139", "23.56.4.50", "23.56.4.66", "23.56.26.161",
    "23.56.97.25", "23.56.97.35", "23.56.109.133", "23.56.109.134", "23.56.109.138",
    "23.56.109.141", "23.56.109.142", "23.56.109.144", "23.56.165.91", "23.56.166.10",
    "23.56.190.65", "23.58.108.29", "23.58.144.43", "23.58.144.50", "23.58.144.198",
    "23.58.144.212", "23.58.144.228", "23.58.144.232", "23.59.166.27", "23.60.73.100",
    "23.60.96.198", "23.61.29.89", "23.61.202.41", "23.61.202.49", "23.61.253.194",
    "23.62.226.130", "23.62.226.142", "23.63.226.152", "23.65.161.151", "23.65.166.62",
    "23.67.33.68", "23.67.33.70", "23.67.33.74", "23.67.33.90", "23.67.33.94",
    "23.67.33.102", "23.72.250.145", "23.72.250.159", "23.75.209.187", "23.192.201.95",
    "23.192.228.82", "23.192.228.88", "23.193.182.18", "23.193.182.19", "23.193.184.135",
    "23.193.184.163", "23.193.186.134", "23.193.186.138", "23.194.17.170", "23.195.81.40",
    "23.195.81.49", "23.195.86.45", "23.195.119.70", "23.195.119.89", "23.195.154.235",
    "23.196.148.75", "23.196.233.192", "23.197.85.47", "23.197.85.65", "23.197.224.29",
    "23.197.237.191", "23.198.101.142", "23.198.102.83", "23.198.217.133", "23.200.150.88",
    "23.200.181.104", "23.200.182.27", "23.200.207.237", "23.201.214.142", "23.203.109.111",
    "23.205.151.5", "23.205.151.49", "23.205.151.77", "23.205.176.112", "23.205.214.10",
    "23.205.214.21", "23.206.71.106", "23.206.229.68", "23.206.229.69", "23.207.78.124",
    "23.207.193.111", "23.208.169.95", "23.208.238.182", "23.209.46.11", "23.209.46.21",
    "23.209.84.8", "23.209.84.16", "23.209.84.31", "23.209.84.34", "23.209.84.46",
    "23.209.84.67", "23.210.33.239", "23.210.42.112", "23.211.213.187", "23.212.62.72",
    "23.212.62.77", "23.212.62.89", "23.212.62.91", "23.212.190.9", "23.212.190.57",
    "23.213.193.233", "23.214.118.190", "23.215.129.208", "23.215.157.102", "23.215.161.108",
    "23.215.162.32", "23.216.147.22", "23.216.147.25", "23.216.153.82", "23.216.153.91",
    "23.216.153.136", "23.216.153.157", "23.216.235.133", "23.216.239.182", "23.216.254.124",
    "23.217.69.187", "23.217.70.159", "23.217.197.76", "23.217.197.236", "23.218.30.189",
    "23.218.109.95", "23.218.110.17", "23.218.239.23", "23.218.239.26", "23.218.239.141",
    "23.218.239.165", "23.219.69.166", "23.219.70.112", "23.219.73.75", "23.219.73.232",
    "23.219.78.39", "23.219.78.44", "23.219.78.71", "23.219.78.72", "23.219.78.167",
    "23.219.78.178", "23.219.78.207", "23.219.78.214", "23.220.68.25", "23.220.68.41",
    "23.220.70.158", "23.220.70.163", "23.220.75.198", "23.220.75.217", "23.220.75.228",
    "23.220.75.229", "23.220.75.230", "23.220.75.233", "23.220.75.234", "23.220.75.236",
    "23.220.75.238", "23.220.75.243", "23.220.75.245", "23.220.75.246", "23.220.75.247",
    "23.220.75.249", "23.220.84.148", "23.220.84.152", "23.220.193.189", "23.220.194.164",
    "23.220.234.197", "23.221.58.124", "23.221.212.197", "23.221.212.203", "23.222.106.163",
    "23.222.110.163", "23.222.167.125", "23.223.25.180", "23.223.119.180", "23.223.196.152",
    "69.192.1.137", "69.192.1.155", "72.246.244.64", "72.246.244.73", "72.246.244.144",
    "72.246.244.146", "72.246.244.155", "72.246.244.184", "72.247.155.96", "72.247.211.145",
    "72.247.211.153", "84.53.132.80", "84.53.172.35", "84.53.172.105", "88.221.123.169",
    "88.221.123.178", "95.101.192.152", "96.16.53.154", "96.16.53.155", "96.16.53.160",
    "96.17.207.148", "96.17.207.161", "100.42.96.33", "104.71.50.203", "104.85.53.193",
    "104.89.102.104", "104.89.105.207", "104.89.224.227", "104.95.111.16", "104.95.111.17",
    "104.96.94.164", "104.110.76.193", "104.115.171.229", "104.115.210.173", "104.120.8.190",
    "104.120.218.57", "104.120.221.178", "104.122.32.120", "104.142.254.227", "173.223.162.83",
    "173.223.162.99", "184.25.110.137", "184.26.43.75", "184.26.43.78", "184.26.172.230",
    "184.27.33.204", "184.27.110.114", "184.27.185.19", "184.27.185.20", "184.27.185.68",
    "184.27.185.69", "184.27.185.70", "184.27.185.73", "184.27.185.78", "184.27.185.88",
    "184.27.185.93", "184.27.185.94", "184.27.185.202", "184.27.185.206", "184.28.41.82",
    "184.28.41.91", "184.28.247.231", "184.29.17.87", "184.29.114.232", "184.85.228.229",
    "184.87.227.147"
]);

const BLOCKED_DOMAINS = new Set([
    // ... (all your other domains)
    "ps4updptl.sa.np.community.playstation.net",
    "event.api.np.km.playstation.net",
    "cc.prod.gaikai.com",
    "config.cc.prod.gaikai.com",
    "rnps-crl.dl.playstation.net",
    "party.rnps.dl.playstation.net",
    "rp.cc.prod.gaikai.com",
    "gs-sec.ww.np.dl.playstation.net"
]);

function main(session) {
    const clientAddress = session.sourceAddress;
    const destAddress = session.destinationAddress;
    const requestDomain = session.domain;

    let shouldBlock = false;

    if (clientAddress === TARGET_SOURCE_IP) {
        if (destAddress && BLOCKED_DEST_IPS.has(destAddress)) {
            shouldBlock = true;
            $surge.log(`BlockPS4Traffic: Script evaluating to TRUE (block) for IP ${destAddress} from source ${clientAddress}. Rule policy REJECT will apply.`);
        }

        if (!shouldBlock && requestDomain && BLOCKED_DOMAINS.has(requestDomain)) {
            shouldBlock = true;
            $surge.log(`BlockPS4Traffic: Script evaluating to TRUE (block) for domain ${requestDomain} from source ${clientAddress}. Rule policy REJECT will apply.`);
        }
    }

    if (shouldBlock) {
        return true; // Script matches, external rule policy (REJECT) will be applied
    } else {
        return false; // Script does not match, external rule policy will NOT be applied
                      // (or return null, which Surge usually interprets as false in this context)
    }
}
